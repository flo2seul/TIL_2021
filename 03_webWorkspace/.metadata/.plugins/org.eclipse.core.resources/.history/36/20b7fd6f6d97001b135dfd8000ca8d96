package servlet.controller;

import java.io.IOException;
import java.sql.SQLException;
import java.util.ArrayList;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import servlet.model.MemberDAOImpl;
import servlet.model.MemberVO;


@WebServlet(urlPatterns = "/front.do", loadOnStartup = 1)
public class DispatcherServlet extends HttpServlet {
	private static final long serialVersionUID = 1L;
     
   
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		doProcess(request, response);
	}


	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		doProcess(request, response);
	}
	
	protected void doProcess(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		//1.Í∞??û•Î®ºÏ? ?ï¥?ïº?ïò?äî ?ùº?? ?Å¥?ùº?ù¥?ñ∏?ä∏Î°úÎ??Ñ∞ ?ñ¥?ñ§ ?öîÏ≤??ù¥ ?ì§?ñ¥?ò§?äîÏß?Î•? ?ïå?ïÑ?ïº ?ïú?ã§...commandÍ∞? Î∞õÏïÑ?ò®?ã§.
		
		//1. RegisterServlet?ùò doProcess(){ ?ïà?óê ?ûà?äî ÏΩîÎìúÎ•? ÏßÅÏ†ë ?ó¨Í∏∞Ïóê ?ûë?Ñ±...Í∂åÏû•?ïòÏß? ?ïä?äî?ã§...
		//2. methodÎ°? ?ïò?Çò ÎΩëÏïÑ?Ç¥?Ñú Í∑? Î©îÏÜå?ìú ?ïà?óê?Ñú RegisterServlet?ùò doProcess(){ ?ïà?óê ?ûà?äî ÏΩîÎìúÎ•? ?ûë?Ñ±...?ù¥ Î∞©Î≤ï?ùÑ Ï∂îÏ≤ú?ïú?ã§.
		String command  =  request.getParameter("command");
		String path = "index.html";//error page, home
		
		if(command.equals("register")){ //?öå?õêÍ∞??ûÖ 
			path=register(request,response);
		}else if(command.equals("find")) { //?öå?õêÍ≤??Éâ
			path=find(request,response);
		}else if(command.equals("login")) { //Î°úÍ∑∏?ù∏
			path=login(request,response);
		}else if(command.equals("allmember")) { //Î™®Îì† ?öå?õê Î≥¥Í∏∞
			path=allmember(request,response);
		}else if(command.equals("logout")) { //Î™®Îì† ?öå?õê Î≥¥Í∏∞
			path=logout(request,response);
		}else if(command.equals("update")) { //Î™®Îì† ?öå?õê Î≥¥Í∏∞
			path=update(request,response);
		}			
		//Î™®Îì† Î©îÏÜå?ìúÍ∞? ?àò?ñâ?ùÑ ?ïú ?í§ ?ã§?ãú ?ù¥Í≥≥ÏúºÎ°? ?èå?ïÑ?ò®?ã§...
		request.getRequestDispatcher(path).forward(request, response);
	}//doProcess
	
	protected String register(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		//AllMember--> register_result.jsp
		//Î°úÏßÅ?? ?ó¨Í∏∞ÏÑú ?ûë?Ñ±..
		String id = request.getParameter("id");
		String password = request.getParameter("password");
		String name = request.getParameter("name");
		String address = request.getParameter("address");
		String path="register_fail.jsp";
		//2.
		MemberVO pvo = new MemberVO(id, password, name, address);
		
		//3. 4. (5) 6. 
		try {
			MemberDAOImpl.getInstance().registerMember(pvo);			
			path = "register_result.jsp";	
		}catch(SQLException e) {
			
		}
		
		return path;
	}
	
	protected String find(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		String id = request.getParameter("id");
		String path = "find_fail.jsp";
		try {
			MemberVO rvo=MemberDAOImpl.getInstance().findByIdMember(id);
			if(rvo!=null) {
				request.setAttribute("vo", rvo);
				path = "find_ok.jsp";
			}
		}catch(SQLException e) {
			
		}
		
		
		return path;
	}
	protected String login(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		String id=  request.getParameter("id");
		String password = request.getParameter("password");
		String path = "";
		try {
			MemberVO rvo=MemberDAOImpl.getInstance().login(id, password);
			
			//?Ñ∏?Öò?óê ???û•?ï¥?ïºÏß?Îß? Î°úÍ∑∏?ù∏ ?èô?ïà ?ù∏Ï¶ùÏùÑ Í≥ÑÏÜç ?ú†Ïß??ï† ?àò ?ûà?ã§.
			HttpSession session = request.getSession();
			if(rvo!=null) {
				session.setAttribute("vo", rvo);
				System.out.println("JSESSIONID :: "+session.getId());				
				path = "login_result.jsp";
			}
		}catch(Exception e) {
			
		}
		return path;
	}
	protected String allmember(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		String path = "";
		try{
			ArrayList<MemberVO> list=MemberDAOImpl.getInstance().showAllMember();
			request.setAttribute("list", list);			
			path = "allView.jsp";
		}catch(SQLException e) {
			
		}
		return path;
	}
	protected String logout(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		String path = "";
		try{
			HttpSession session = request.getSession();
			if(session.getAttribute("vo")!=null) { //Î°úÍ∑∏?ù∏ ?êú ?ÉÅ?Éú?ùºÎ©?
				session.invalidate();
				path = "logout.jsp";
			}
		}catch(Exception e) {
			
		}
		return path;
	}
	protected String update(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		String id = request.getParameter("id");
		String password = request.getParameter("password");
		String name = request.getParameter("name");
		String address = request.getParameter("address");
		
		//2.
		MemberVO pvo = new MemberVO(id, password, name, address);
		
		String path="index.jsp";
		try{
			System.out.println("aaaa");
			MemberDAOImpl.getInstance().updateMember(pvo);
			HttpSession session  = request.getSession();
			if(session.getAttribute("vo")!=null) {
				session.setAttribute("vo", pvo);
				System.out.println(pvo);
				path = "update_result.jsp";
			}
		}catch(Exception e) {
			
		}
		return path;
	}
}

/*
 * Î°úÍ∑∏?ù∏, ?†ïÎ≥¥Ïàò?†ï?? Î°úÏßÅ?? Î∞òÎìú?ãú ?Ñ∏?Öò?óê Î∞îÏù∏?î©.....
 */
















